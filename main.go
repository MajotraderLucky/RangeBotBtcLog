package main

import (
	"context"
	"encoding/json"
	"log"
	"os"

	"github.com/MajotraderLucky/MarketRepository/initlog"
	"github.com/MajotraderLucky/MarketRepository/positionlog"
	"github.com/MajotraderLucky/Utils/logger"
)

// The function returns the volume of an open position.
func getAccountPositions() {
	futuresClient := initlog.NewFuturesClient()
	accServ, err := futuresClient.NewGetAccountService().Do(context.Background())
	if err != nil {
		log.Println(err)
		return
	}
	accServVar, _ := json.Marshal(accServ)
	fileJson, err := json.Marshal(accServ)
	if err != nil {
		panic(err)
	}
	err = os.WriteFile("fileJson.json", fileJson, 0644)
	if err != nil {
		panic(err)
	}
	var autoGeneratedPos positionlog.AutoGeneratedPos
	json.Unmarshal(accServVar, &autoGeneratedPos)

	var positionBTCindex int

	for k := 0; k < len(autoGeneratedPos.Positions); k++ {
		if autoGeneratedPos.Positions[k].Symbol == "BTCUSDT" {
			positionBTCindex = k
		}
	}
	log.Println("Item positions total:", autoGeneratedPos.Positions[positionBTCindex].PositionAmt)
}

func getAutoGeneratedPos() positionlog.AutoGeneratedPos {
	futuresClient := initlog.NewFuturesClient()
	accServ, err := futuresClient.NewGetAccountService().Do(context.Background())
	if err != nil {
		log.Println(err)
		return positionlog.AutoGeneratedPos{}
	}
	accServVar, _ := json.Marshal(accServ)
	fileJson, err := json.Marshal(accServ)
	if err != nil {
		log.Println(err)
		return positionlog.AutoGeneratedPos{}
	}
	err = os.WriteFile("fileJson.json", fileJson, 0644)
	if err != nil {
		panic(err)
	}
	var autoGeneratedPos positionlog.AutoGeneratedPos
	json.Unmarshal(accServVar, &autoGeneratedPos)

	return autoGeneratedPos
}

func main() {
	logger := logger.Logger{}
	err := logger.CreateLogsDir()
	if err != nil {
		log.Fatal(err)
	}
	err = logger.OpenLogFile()
	if err != nil {
		log.Fatal(err)
	}
	logger.SetLogger()
	logger.LogLine()

	// If all files are found, start the program
	if initlog.CheckFilesExist() {
		log.Println("----------All files found, starting program----------")
	}

	log.Println("Btc bot started...")

	initlog.Init()

	autoGeneratedPos := getAutoGeneratedPos()
	hasOpenPos := positionlog.HasOpenPositions(autoGeneratedPos)
	log.Println("Has open positions: ", hasOpenPos)
	getAccountPositions()

	logger.LogLine()

	logger.CleanLog()
}
